{% extends 'matcher/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    /* --- Styles จาก Master Design --- */
    nav.navbar, footer { display: none !important; }
    
    .container {
        width: 100% !important;
        max-width: 100% !important;
        padding: 0 !important;
        margin: 0 !important;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: #0f1219;
        margin: 0;
        padding: 0;
        color: white;
        overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #0f1219; }
    ::-webkit-scrollbar-thumb { background: #2c3e50; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #34495e; }

    .admin-container { display: flex; min-height: 100vh; }

    /* Sidebar Style (ตามต้นแบบ) */
    .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #3a1c71, #1e2235 60%, #0f1219 100%);
        padding: 30px 20px;
        position: fixed;
        top: 0; left: 0;
        height: 100vh;
        z-index: 1000;
        display: flex; flex-direction: column;
        box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    }

    .brand { 
        font-size: 1.8rem; font-weight: 700; margin-bottom: 40px; 
        color: white; text-align: center; letter-spacing: 1px;
    }

    .menu-list { display: flex; flex-direction: column; gap: 10px; }

    .menu-item {
        display: flex; align-items: center; gap: 15px;
        padding: 12px 20px;
        color: #a0a0a0; text-decoration: none;
        font-size: 0.95rem; transition: 0.3s;
        border-radius: 12px; font-weight: 500;
    }

    .menu-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: white; transform: translateX(5px);
    }

    .menu-item.active {
        background: linear-gradient(90deg, rgba(52, 152, 219, 0.2), transparent);
        color: #3498db; position: relative;
    }
    .menu-item.active::before {
        content: ''; position: absolute; left: 0; height: 100%; width: 4px;
        background: #3498db; border-radius: 0 5px 5px 0;
    }

    .logout-btn {
        margin-top: auto; display: flex; align-items: center; gap: 10px;
        color: #7f8c8d; text-decoration: none; font-size: 0.95rem;
        transition: 0.3s; padding: 12px 20px; border-radius: 12px;
    }
    .logout-btn:hover { color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

    /* Main Content */
    .main-content {
        flex: 1; margin-left: 260px; padding: 40px 50px;
        background-color: #121622; min-height: 100vh;
    }

    .top-bar {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px;
    }
    .page-title { font-size: 2rem; font-weight: 700; }

    .search-box { position: relative; }
    .search-box input {
        background: #1e2333; border: 1px solid #2e3446;
        padding: 12px 20px 12px 45px; border-radius: 50px;
        color: #ccc; outline: none; width: 300px; transition: 0.3s;
    }
    .search-box input:focus { border-color: #3498db; width: 320px; }
    .search-box i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #777; }

    /* Cards & Stats (Applied Style from Master) */
    .card {
        background: #1b202e; border-radius: 20px; padding: 25px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 30px;
    }
    .card-header {
        font-size: 1.2rem; font-weight: 600; margin-bottom: 20px;
        color: #ecf0f1; border-bottom: 1px solid #2a3040;
        padding-bottom: 15px; display: flex; align-items: center; gap: 10px;
    }

    .stats-row {
        display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px;
    }
    .stat-card-custom {
        background: #23293a; border-radius: 18px; padding: 25px;
        display: flex; flex-direction: column; justify-content: center;
        transition: 0.3s;
    }
    .stat-card-custom:hover { transform: translateY(-5px); background: #2a3245; }
    .stat-title { font-size: 0.9rem; color: #95a5a6; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
    .stat-value { font-size: 2.2rem; font-weight: 700; color: white; }

    /* Gender Bar Custom */
    .gender-bars { display: flex; gap: 5px; margin-top: 15px; height: 8px; width: 100%; background: #1e2235; border-radius: 4px; overflow: hidden; }
    .g-fill { height: 100%; }

    /* Table Styles (Matched Master) */
    .full-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    .full-table th { 
        color: #95a5a6; text-align: left; padding: 12px 15px; 
        font-weight: 600; text-transform: uppercase; font-size: 0.8rem;
        background: #23293a; border-radius: 4px;
    }
    .full-table td { padding: 15px; border-bottom: 1px solid #2a3040; color: #dfe6e9; }
    .full-table tr:hover td { background-color: rgba(255,255,255,0.02); }
    .full-table tr:last-child td { border-bottom: none; }

    .status-active { color: #2ecc71; background: rgba(46, 204, 113, 0.15); padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; }
    .status-banned { color: #e74c3c; background: rgba(231, 76, 60, 0.15); padding: 5px 12px; border-radius: 50px; font-size: 0.85rem; font-weight: 600; }
    
    .genre-badge { background: rgba(52, 152, 219, 0.15); color: #3498db; padding: 4px 12px; border-radius: 50px; font-size: 0.8rem; font-weight: 600; }

    /* Action Menu */
    .action-dropdown { position: relative; display: inline-block; }
    .action-dots { color: #777; cursor: pointer; padding: 8px; transition: 0.2s; border-radius: 50%; }
    .action-dots:hover { color: white; background: rgba(255,255,255,0.1); }
    .dropdown-content {
        display: none; position: absolute; right: 0; background-color: #23293a;
        min-width: 160px; box-shadow: 0px 8px 16px rgba(0,0,0,0.5);
        z-index: 1001; border-radius: 12px; border: 1px solid #2e3446; overflow: hidden;
    }
    .dropdown-content a { color: #ddd; padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; }
    .dropdown-content a:hover { background-color: rgba(255,255,255,0.05); color: white; }
    .show { display: block; }

</style>

{% with current=request.resolver_match.url_name %}
<div class="admin-container">

    <div class="sidebar">
        <div class="brand">
            <i class="fas fa-shield-alt"></i> Admin Panel
        </div>

        <div class="menu-list">
            <a href="{% url 'matcher:admin_panel' %}" class="menu-item {% if current == 'admin_panel' %}active{% endif %}">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>

            <a href="{% url 'matcher:user_management' %}" class="menu-item {% if current == 'user_management' %}active{% endif %}">
                <i class="fas fa-users-cog"></i> User Management
            </a>

            <a href="{% url 'matcher:behavior_analysis' %}" class="menu-item {% if current == 'behavior_analysis' %}active{% endif %}">
                <i class="fas fa-chart-line"></i> Behavior Analysis
            </a>

            <a href="{% url 'matcher:song_database' %}" class="menu-item {% if current == 'song_database' %}active{% endif %}">
                <i class="fas fa-music"></i> Song Database
            </a>

            <a href="{% url 'matcher:category_management' %}" class="menu-item {% if current == 'category_management' %}active{% endif %}">
                <i class="fas fa-tags"></i> Category & Mood
            </a>

            <a href="{% url 'matcher:model_management' %}" class="menu-item {% if current == 'model_management' %}active{% endif %}">
                <i class="fas fa-brain"></i> AI Model
            </a>
        </div>

        <a href="{% url 'matcher:logout' %}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <div class="main-content">
        <div class="top-bar">
            <div class="page-title">Behavior Analysis</div>
            <div style="display: flex; gap: 20px; align-items: center;">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="userSearchInput" placeholder="Search user or genre..." onkeyup="filterTable()">
                </div>
                <div style="display: flex; align-items: center; gap: 10px; color: white;">
                    <div style="text-align: right;">
                        <div style="font-weight: 600; font-size: 0.9rem;">{{ request.user.username }}</div>
                        <div style="font-size: 0.8rem; color: #aaa;">Administrator</div>
                    </div>
                    <i class="fas fa-user-circle" style="font-size: 2.5rem;"></i>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card-custom">
                <div class="stat-title">Avg. Age</div>
                <div class="stat-value">{{ avg_age|default:"-" }} <span style="font-size: 1rem; color:#aaa; font-weight:400;">yrs</span></div>
            </div>

            <div class="stat-card-custom">
                <div class="stat-title">Demographics</div>
                <div style="font-size: 0.9rem; font-weight: 600; margin-bottom:5px; display:flex; justify-content:space-between;">
                    <span style="color:#3498db">Male: {{ male_percent }}%</span> 
                    <span style="color:#e74c3c">Fem: {{ female_percent }}%</span>
                </div>
                <div class="gender-bars">
                    <div class="g-fill" style="width: {{ male_percent }}%; background: #3498db;"></div>
                    <div class="g-fill" style="width: {{ female_percent }}%; background: #e74c3c;"></div>
                    <div class="g-fill" style="width: {{ other_percent }}%; background: #f1c40f;"></div>
                </div>
            </div>

            <div class="stat-card-custom">
                <div class="stat-title">Top Favorite Genre</div>
                <div class="stat-value" style="font-size: 1.8rem;">{{ top_genre|title|default:"N/A" }}</div>
            </div>

            <div class="stat-card-custom">
                <div class="stat-title">Total Interactions</div>
                <div class="stat-value">{{ total_interactions }}</div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <span><i class="fas fa-users"></i> User Insights & Preferences</span>
            </div>

            <table class="full-table" id="userTable">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Gender</th>
                        <th>Age</th>
                        <th>Favorite Genre</th>
                        <th>Status</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in user_data %}
                    <tr>
                        <td>
                            <div style="font-weight: 600; color:white;">{{ u.user.username }}</div>
                            <div style="font-size: 0.8rem; color: #7f8c8d;">{{ u.user.email }}</div>
                        </td>
                        <td style="text-transform: capitalize;">{{ u.user.gender|default:"-" }}</td>
                        <td>{{ u.user.age|default:"-" }}</td>
                        <td>
                            {% if u.top_genre %}
                                <span class="genre-badge">{{ u.top_genre|title }}</span>
                            {% else %}
                                <span style="color: #555; font-size: 0.85rem;">No Data</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if u.user.is_active %}
                                <span class="status-active">Active</span>
                            {% else %}
                                <span class="status-banned">Banned</span>
                            {% endif %}
                        </td>
                        <td style="text-align: right;">
                            <div class="action-dropdown">
                                <i class="fas fa-ellipsis-v action-dots" onclick="toggleMenu('menu-{{ u.user.id }}')"></i>
                                <div id="menu-{{ u.user.id }}" class="dropdown-content">
                                    <a href="{% url 'matcher:toggle_user_status' u.user.id %}">
                                        {% if u.user.is_active %}Suspend Account{% else %}Activate Account{% endif %}
                                    </a>
                                    <a href="{% url 'matcher:delete_user' u.user.id %}" style="color: #ff6b6b;" onclick="return confirm('Delete this user permanently?')">Delete User</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="6" style="text-align:center; padding:30px; color:#555;">No user data found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>
{% endwith %}

<script>
    function toggleMenu(menuId) {
        document.querySelectorAll('.dropdown-content').forEach(menu => {
            if (menu.id !== menuId) menu.classList.remove('show');
        });
        document.getElementById(menuId).classList.toggle('show');
    }
    
    window.onclick = function(event) {
        if (!event.target.matches('.action-dots')) {
            document.querySelectorAll('.dropdown-content').forEach(menu => menu.classList.remove('show'));
        }
    }

    function filterTable() {
        let input = document.getElementById("userSearchInput");
        let filter = input.value.toUpperCase();
        let table = document.getElementById("userTable");
        let tr = table.getElementsByTagName("tr");
        for (let i = 1; i < tr.length; i++) {
            let tdName = tr[i].getElementsByTagName("td")[0];
            let tdGenre = tr[i].getElementsByTagName("td")[3];
            if (tdName || tdGenre) {
                let txtName = tdName.textContent || tdName.innerText;
                let txtGenre = tdGenre.textContent || tdGenre.innerText;
                if (txtName.toUpperCase().indexOf(filter) > -1 || txtGenre.toUpperCase().indexOf(filter) > -1) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}