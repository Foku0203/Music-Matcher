{% extends 'matcher/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

<style>
    @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
    
    /* --- Master Design Reset --- */
    nav.navbar, footer { display: none !important; }
    .container { width: 100% !important; max-width: 100% !important; padding: 0 !important; margin: 0 !important; }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: #0f1219;
        margin: 0; padding: 0;
        color: white; overflow-x: hidden;
    }

    .admin-container { display: flex; min-height: 100vh; }

    /* Sidebar (Master) */
    .sidebar {
        width: 260px;
        background: linear-gradient(180deg, #3a1c71, #1e2235 60%, #0f1219 100%);
        padding: 30px 20px;
        position: fixed; top: 0; left: 0; height: 100vh;
        z-index: 1000; display: flex; flex-direction: column;
        box-shadow: 4px 0 15px rgba(0,0,0,0.3);
    }
    .brand { font-size: 1.8rem; font-weight: 700; margin-bottom: 40px; color: white; text-align: center; letter-spacing: 1px; }
    .menu-list { display: flex; flex-direction: column; gap: 10px; }
    .menu-item {
        display: flex; align-items: center; gap: 15px; padding: 12px 20px;
        color: #a0a0a0; text-decoration: none; font-size: 0.95rem;
        transition: 0.3s; border-radius: 12px; font-weight: 500;
    }
    .menu-item:hover { background: rgba(255, 255, 255, 0.05); color: white; transform: translateX(5px); }
    .menu-item.active { background: linear-gradient(90deg, rgba(52, 152, 219, 0.2), transparent); color: #3498db; position: relative; }
    .menu-item.active::before { content: ''; position: absolute; left: 0; height: 100%; width: 4px; background: #3498db; border-radius: 0 5px 5px 0; }
    .logout-btn { margin-top: auto; display: flex; align-items: center; gap: 10px; color: #7f8c8d; text-decoration: none; padding: 12px 20px; border-radius: 12px; transition: 0.3s; }
    .logout-btn:hover { color: #e74c3c; background: rgba(231, 76, 60, 0.1); }

    /* Main Content */
    .main-content { flex: 1; margin-left: 260px; padding: 40px 50px; background-color: #121622; min-height: 100vh; }

    /* Top Bar */
    .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
    .page-title { font-size: 2rem; font-weight: 700; }
    .page-subtitle { font-size: 0.9rem; color: #888; margin-top: 5px; }

    /* Custom Button */
    .btn-primary-custom {
        background: linear-gradient(135deg, #3498db, #2980b9);
        color: white; padding: 12px 25px; border-radius: 50px; border: none;
        font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 10px;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.4); transition: 0.3s; text-decoration: none;
    }
    .btn-primary-custom:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.6); }

    /* Filter Bar */
    .filter-card {
        background: #1b202e; padding: 20px; border-radius: 20px; margin-bottom: 25px;
        display: flex; gap: 15px; align-items: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    .custom-input {
        background: #121622; border: 1px solid #2e3446; padding: 10px 15px;
        border-radius: 8px; color: white; outline: none; width: 100%; transition: 0.3s;
    }
    .custom-input:focus { border-color: #3498db; }
    .custom-select {
        background: #121622; border: 1px solid #2e3446; padding: 10px 15px;
        border-radius: 8px; color: #ccc; outline: none; cursor: pointer; min-width: 150px;
    }

    /* Table */
    .card { background: #1b202e; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    .full-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    .full-table th { 
        color: #95a5a6; text-align: left; padding: 15px; font-weight: 600;
        text-transform: uppercase; font-size: 0.8rem; border-bottom: 1px solid #2a3040;
        background: #23293a; border-radius: 4px;
    }
    .full-table td { padding: 15px; border-bottom: 1px solid #2a3040; color: #dfe6e9; vertical-align: middle; }
    .full-table tr:hover td { background-color: rgba(255,255,255,0.02); }
    .full-table tr:last-child td { border-bottom: none; }

    /* Song Info */
    .song-flex { display: flex; align-items: center; gap: 15px; }
    .cover-wrapper {
        width: 50px; height: 50px; border-radius: 8px; overflow: hidden; flex-shrink: 0;
        background: #333; display: flex; justify-content: center; align-items: center;
        border: 1px solid #2e3446;
    }
    .cover-img { width: 100%; height: 100%; object-fit: cover; }

    /* Badges */
    .badge { padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-right: 4px; margin-bottom: 4px; }
    .badge-mood { background: rgba(155, 93, 229, 0.15); color: #9b5de5; border: 1px solid rgba(155, 93, 229, 0.3); }
    .badge-genre { background: rgba(230, 126, 34, 0.15); color: #e67e22; border: 1px solid rgba(230, 126, 34, 0.3); }

    /* Action Buttons */
    .action-btn {
        width: 32px; height: 32px; border-radius: 8px; border: none; cursor: pointer;
        display: inline-flex; justify-content: center; align-items: center; transition: 0.2s; margin-left: 5px;
        text-decoration: none;
    }
    .btn-edit { background: rgba(52, 152, 219, 0.15); color: #3498db; }
    .btn-edit:hover { background: #3498db; color: white; }
    .btn-del { background: rgba(231, 76, 60, 0.15); color: #e74c3c; }
    .btn-del:hover { background: #e74c3c; color: white; }

    /* Pagination */
    .pagination-container {
        display: flex; justify-content: center; align-items: center;
        margin-top: 25px; gap: 8px;
    }
    .page-btn {
        padding: 8px 14px;
        background: #23293a;
        color: #ccc;
        border-radius: 8px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: 0.2s;
        border: 1px solid rgba(255,255,255,0.05);
    }
    .page-btn:hover { background: #3498db; color: white; border-color: #3498db; }
    .page-btn.active { background: #3498db; color: white; border-color: #3498db; pointer-events: none; }
    .page-btn.disabled { opacity: 0.5; pointer-events: none; }
    .page-info { color: #888; font-size: 0.9rem; margin: 0 10px; }

    /* Modal */
    .modal-overlay {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center;
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background: #1b202e; width: 700px; padding: 30px; border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5); border: 1px solid #2e3446;
        position: relative; animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid #2e3446; padding-bottom: 15px; }
    .modal-title { font-size: 1.5rem; font-weight: 600; }
    .close-modal { background: none; border: none; color: #777; font-size: 1.5rem; cursor: pointer; }
    .close-modal:hover { color: white; }

    .form-group { margin-bottom: 15px; }
    .form-label { display: block; margin-bottom: 8px; color: #ccc; font-size: 0.9rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
</style>

{% with current=request.resolver_match.url_name %}
<div class="admin-container">

    <div class="sidebar">
        <div class="brand"><i class="fas fa-shield-alt"></i> Admin Panel</div>
        <div class="menu-list">
            <a href="{% url 'matcher:admin_panel' %}" class="menu-item {% if current == 'admin_panel' %}active{% endif %}">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>
            <a href="{% url 'matcher:user_management' %}" class="menu-item {% if current == 'user_management' %}active{% endif %}">
                <i class="fas fa-users-cog"></i> User Management
            </a>
            <a href="{% url 'matcher:behavior_analysis' %}" class="menu-item {% if current == 'behavior_analysis' %}active{% endif %}">
                <i class="fas fa-chart-line"></i> Behavior Analysis
            </a>
            <a href="{% url 'matcher:song_database' %}" class="menu-item {% if current == 'song_database' %}active{% endif %}">
                <i class="fas fa-music"></i> Song Database
            </a>
            <a href="{% url 'matcher:category_management' %}" class="menu-item {% if current == 'category_management' %}active{% endif %}">
                <i class="fas fa-tags"></i> Category & Mood
            </a>
            <a href="{% url 'matcher:model_management' %}" class="menu-item {% if current == 'model_management' %}active{% endif %}">
                <i class="fas fa-brain"></i> AI Model
            </a>
        </div>
        <a href="{% url 'matcher:logout' %}" class="logout-btn">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>
    </div>

    <div class="main-content">

        <div class="top-bar">
            <div>
                <div class="page-title">Song Database</div>
                <div class="page-subtitle">Manage music tracks, genres, and AI moods</div>
            </div>
            <button onclick="openAddModal()" class="btn-primary-custom">
                <i class="fas fa-plus"></i> Add New Song
            </button>
        </div>

        <form method="get" class="filter-card">
            <div style="flex: 2; position: relative;">
                <i class="fas fa-search" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #777;"></i>
                <input type="text" name="q" class="custom-input" style="padding-left: 35px;" 
                       placeholder="Search title, artist, album (Press Enter)" value="{{ query|default:'' }}">
            </div>
            
            <select name="genre" class="custom-select" onchange="this.form.submit()">
                <option value="">All Genres</option>
                {% for g in all_genres %}
                    <option value="{{ g }}" {% if selected_genre == g %}selected{% endif %}>{{ g }}</option>
                {% endfor %}
            </select>

            <select name="mood" class="custom-select" onchange="this.form.submit()">
                <option value="">All Moods</option>
                {% for m in all_moods %}
                    <option value="{{ m }}" {% if selected_mood == m %}selected{% endif %}>{{ m }}</option>
                {% endfor %}
            </select>

            {% if query or selected_genre or selected_mood %}
            <a href="{% url 'matcher:song_database' %}" class="btn-primary-custom" style="background:#e74c3c; box-shadow:none; padding:10px 15px; border-radius:8px; display:inline-flex; align-items:center; height:42px;">
                <i class="fas fa-times"></i>
            </a>
            {% endif %}
        </form>

        <div class="card">
            <div style="margin-bottom: 20px; font-weight: 600; color: #ccc; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <i class="fas fa-music"></i> Total Songs: 
                    <span style="background:#2e3446; padding:2px 8px; border-radius:4px;">{{ songs.paginator.count|default:songs.count }}</span>
                </div>
                <div style="font-size: 0.85rem; color: #777;">
                    Showing page {{ songs.number }} of {{ songs.paginator.num_pages }}
                </div>
            </div>

            <table class="full-table">
                <thead>
                    <tr>
                        <th width="50">#</th>
                        <th>Track Info</th>
                        <th>Genre</th>
                        <th>Mood</th>
                        <th style="text-align: right;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for song in songs %}
                    <tr>
                        <td style="color:#666;">
                            {{ songs.start_index|add:forloop.counter0 }}
                        </td>
                        <td>
                            <div class="song-flex">
                                <div class="cover-wrapper">
                                    {% if song.image_url %}
                                        <img src="{{ song.image_url }}" class="cover-img" onerror="this.src='https://via.placeholder.com/50'">
                                    {% elif song.album and song.album.cover_url %}
                                        <img src="{{ song.album.cover_url }}" class="cover-img">
                                    {% else %}
                                        <i class="fas fa-music" style="color:#777;"></i>
                                    {% endif %}
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.95rem;">{{ song.title }}</div>
                                    <div style="color: #aaa; font-size: 0.85rem;">{{ song.artist.name }}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if song.json_genre %}
                                <span class="badge badge-genre">{{ song.json_genre }}</span>
                            {% else %}
                                <span style="color:#555;">-</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if song.json_mood %}
                                <span class="badge badge-mood">{{ song.json_mood }}</span>
                            {% else %}
                                <span style="color:#555;">-</span>
                            {% endif %}
                        </td>
                        <td style="text-align: right;">
                            <button type="button" class="action-btn btn-edit" title="Edit" 
                                    onclick="openEditModal({
                                        id: '{{ song.song_id }}',
                                        title: '{{ song.title|escapejs }}',
                                        artist: '{{ song.artist.name|escapejs }}',
                                        album: '{{ song.album.title|default:''|escapejs }}',
                                        json_genre: '{{ song.json_genre|default:''|escapejs }}',
                                        json_mood: '{{ song.json_mood|default:''|escapejs }}',
                                        image_url: '{{ song.image_url|default:''|escapejs }}',
                                        genius_url: '{{ song.genius_url|default:''|escapejs }}'
                                    })">
                                <i class="fas fa-pen"></i>
                            </button>

                            <a href="{% url 'matcher:delete_song' song.song_id %}" 
                               onclick="return confirm('Are you sure you want to delete this song?')" 
                               class="action-btn btn-del" title="Delete">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" style="text-align:center; padding:30px; color:#555;">No songs found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if songs.has_other_pages %}
            <div class="pagination-container">
                {% if songs.has_previous %}
                    <a href="?page=1{% if query %}&q={{ query }}{% endif %}{% if selected_genre %}&genre={{ selected_genre }}{% endif %}{% if selected_mood %}&mood={{ selected_mood }}{% endif %}" class="page-btn">&laquo; First</a>
                    <a href="?page={{ songs.previous_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_genre %}&genre={{ selected_genre }}{% endif %}{% if selected_mood %}&mood={{ selected_mood }}{% endif %}" class="page-btn">Prev</a>
                {% else %}
                    <span class="page-btn disabled">&laquo; First</span>
                    <span class="page-btn disabled">Prev</span>
                {% endif %}

                <span class="page-info">
                    Page {{ songs.number }} of {{ songs.paginator.num_pages }}
                </span>

                {% if songs.has_next %}
                    <a href="?page={{ songs.next_page_number }}{% if query %}&q={{ query }}{% endif %}{% if selected_genre %}&genre={{ selected_genre }}{% endif %}{% if selected_mood %}&mood={{ selected_mood }}{% endif %}" class="page-btn">Next</a>
                    <a href="?page={{ songs.paginator.num_pages }}{% if query %}&q={{ query }}{% endif %}{% if selected_genre %}&genre={{ selected_genre }}{% endif %}{% if selected_mood %}&mood={{ selected_mood }}{% endif %}" class="page-btn">Last &raquo;</a>
                {% else %}
                    <span class="page-btn disabled">Next</span>
                    <span class="page-btn disabled">Last &raquo;</span>
                {% endif %}
            </div>
            {% endif %}

        </div>

    </div>
</div>

<div id="songModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title" id="modalTitle">Add New Song</div>
            <button type="button" class="close-modal" onclick="closeModal()">&times;</button>
        </div>
        
        <form method="post" action="{% url 'matcher:save_song' %}" enctype="multipart/form-data">
            {% csrf_token %}
            <input type="hidden" name="song_id" id="modal_song_id">

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Song Title <span style="color:#e74c3c;">*</span></label>
                    <input type="text" name="title" id="modal_title" class="custom-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Artist Name <span style="color:#e74c3c;">*</span></label>
                    <input type="text" name="artist" id="modal_artist" class="custom-input" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Album Name</label>
                <input type="text" name="album" id="modal_album" class="custom-input" placeholder="Optional">
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">JSON Genre</label>
                    <input type="text" name="json_genre" id="modal_json_genre" class="custom-input" placeholder="e.g. Pop, Rock">
                </div>
                <div class="form-group">
                    <label class="form-label">JSON Mood</label>
                    <input type="text" name="json_mood" id="modal_json_mood" class="custom-input" placeholder="e.g. Happy, Sad">
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Image URL (Cover)</label>
                <input type="url" name="image_url" id="modal_image_url" class="custom-input" placeholder="https://example.com/cover.jpg">
            </div>

            <div class="form-group">
                <label class="form-label">Genius URL (Lyrics/Info)</label>
                <input type="url" name="genius_url" id="modal_genius_url" class="custom-input" placeholder="https://genius.com/...">
            </div>

            <div class="form-group" style="border-top: 1px solid #2e3446; padding-top: 15px; margin-top: 15px;">
                <label class="form-label" style="font-size: 0.8rem; color:#777;">Or Upload Local File (Album Cover)</label>
                <input type="file" name="cover_image" class="custom-input" accept="image/*" style="padding: 8px;">
            </div>
            
            <div style="text-align: right; margin-top: 25px;">
                <button type="button" onclick="closeModal()" class="btn-primary-custom" style="background:#444; display:inline-flex; box-shadow:none; margin-right:10px;">Cancel</button>
                <button type="submit" class="btn-primary-custom" style="display:inline-flex;">Save Song</button>
            </div>
        </form>
    </div>
</div>

{% endwith %}

<script>
    const modal = document.getElementById('songModal');

    function openAddModal() {
        document.getElementById('modalTitle').innerText = "Add New Song";
        document.getElementById('modal_song_id').value = "";
        
        // Reset Inputs
        const fields = ['title', 'artist', 'album', 'json_genre', 'json_mood', 'image_url', 'genius_url'];
        fields.forEach(id => document.getElementById('modal_' + id).value = "");
        
        modal.style.display = "flex";
    }

    function openEditModal(data) {
        document.getElementById('modalTitle').innerText = "Edit Song";
        document.getElementById('modal_song_id').value = data.id;
        
        document.getElementById('modal_title').value = data.title;
        document.getElementById('modal_artist').value = data.artist;
        document.getElementById('modal_album').value = data.album;
        document.getElementById('modal_json_genre').value = data.json_genre;
        document.getElementById('modal_json_mood').value = data.json_mood;
        document.getElementById('modal_image_url').value = data.image_url;
        document.getElementById('modal_genius_url').value = data.genius_url;

        modal.style.display = "flex";
    }

    function closeModal() {
        modal.style.display = "none";
    }

    // Close when clicking outside
    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }
</script>
{% endblock %}